---
# =========================================================================
#  MONGODB STATEFULSET (DATABASE LAYER)
# Ensures persistent storage, unique identity, and ordered deployment/deletion.
# =========================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongo-db
  labels:
    app: mongo
    environment: production
spec:
  # Use 3 replicas for a robust MongoDB replica set (for high availability)
  serviceName: mongo-svc # Must match the Headless Service name
  replicas: 3
  selector:
    matchLabels:
      app: mongo
  template:
    metadata:
      labels:
        app: mongo
        version: v4.4 # Specify a known stable MongoDB version tag
    spec:
      # Gives the database time to flush buffers and close connections
      terminationGracePeriodSeconds: 60
      containers:
        - name: mongo-container
          image: mongo:4.4 # Using a specific stable image
          ports:
            - containerPort: 27017

          # Resource Management: Essential for DB stability and performance
          resources:
            requests:
              cpu: "300m"
              memory: "768Mi"
            limits:
              cpu: "1500m" # 1.5 CPU Core Limit
              memory: "2Gi" # Hard memory limit for the DB

          # Environment Variables (using ConfigMap and Secret)
          env:
            # Root Username from Secret
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mern-app-secrets
                  key: mongo-root-username
            # Root Password from Secret
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mern-app-secrets
                  key: mongo-root-password
            # Initial Database Name from ConfigMap
            - name: MONGO_INITDB_DATABASE
              valueFrom:
                configMapKeyRef:
                  name: mern-app-config
                  key: db-name

          # Health Probes: Ensures the MongoDB process is running and ready.
          livenessProbe:
            exec:
              command:
                - mongo
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5

          readinessProbe:
            exec:
              command:
                - mongo
                - --eval
                - "db.adminCommand('replSetGetStatus')"
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3

          volumeMounts:
            - name: mongo-data
              mountPath: /data/db

  # Persistent Volume Claim Template
  volumeClaimTemplates:
    - metadata:
        name: mongo-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3 # Use a high-performance storage class
        resources:
          requests:
            storage: 20Gi # Increased storage to 20Gi for production data

---
#  MONGODB HEADLESS SERVICE (Internal DNS for StatefulSet)
# Used for stable network identity and replica set configuration.
apiVersion: v1
kind: Service
metadata:
  name: mongo-svc # Used in the MONGO_URI string
  labels:
    app: mongo
spec:
  clusterIP: None # Defines the Headless Service
  selector:
    app: mongo
  ports:
    - port: 27017
      targetPort: 27017
      name: mongo

---
#  MONGODB CLUSTERIP SERVICE (General Cluster Access)
# Simple service for internal clients (like the Backend) to connect.
apiVersion: v1
kind: Service
metadata:
  name: mongo-service # The general name used by the backend initially
  labels:
    app: mongo
spec:
  selector:
    app: mongo
  ports:
    - port: 27017
      targetPort: 27017
  type: ClusterIP
